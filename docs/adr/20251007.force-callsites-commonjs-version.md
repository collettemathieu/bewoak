# Architecture Decision Record (ADR)

## Title

Force callsites package to CommonJS version 3.1.0 to maintain cucumber-tsflow compatibility

## Status

Accepted

## Context

Cucumber test execution with cucumber-tsflow@4.5.2 was failing with the following error:

```bash
Error [ERR_REQUIRE_ESM]: require() of ES Module /Users/claudedebussy/Works/Projects/bewoak/node_modules/callsites/index.js from /Users/claudedebussy/Works/Projects/bewoak/node_modules/cucumber-tsflow/dist/our-callsite.js not supported.
```

### Problem Analysis

1. **cucumber-tsflow@4.5.2** declares a dependency `"callsites": "^4.2.0"` in its package.json
2. **callsites@4.2.0** became a pure ES module (ESM)
3. **cucumber-tsflow compiled code** still uses `require("callsites")` instead of `import`
4. **Node.js** no longer allows importing ES modules with `require()` since Node.js 12+

This incompatibility prevents the execution of Cucumber tests using TypeScript decorators (`@given`, `@when`, `@then`) because cucumber-tsflow can no longer access the call stack information needed to map step definitions.

The issue affects all monorepo projects using cucumber-tsflow:

- `pathway-design-server-pathway-application`
- `pathway-design-server-pathway-business`

## Decision

Use Bun's `resolutions` mechanism to force the use of `callsites@3.1.0` (CommonJS version) throughout the entire dependency tree.

Configuration added to root package.json:

```json
{
  "resolutions": {
    "callsites": "3.1.0"
  }
}
```

## Alternatives Considered

### 1. Upgrade to a fixed version of cucumber-tsflow

- **Rejected**: No fixed version available at the time of decision
- **Risk**: External dependency not under our control

### 2. Migration to standard Cucumber API without decorators

- **Rejected**: Major impact on existing codebase
- **Effort**: Complete rewrite of all step definitions required
- **Timeline**: Several days of work

### 3. Using a custom Node.js loader

- **Rejected**: High technical complexity
- **Maintenance**: Fragile solution and difficult to maintain
- **Compatibility**: Potential issues with Bun

### 4. Fork and fix cucumber-tsflow

- **Rejected**: Maintaining a fork is undesirable
- **Resources**: Development and maintenance time not justified

## Consequences

### Positive

- ✅ **Functional tests**: All Cucumber tests work again
- ✅ **Quick solution**: Implementation in minutes
- ✅ **Minimal impact**: No code changes required
- ✅ **Reversible**: Easily removable when cucumber-tsflow is fixed

### Negative

- ⚠️ **Frozen dependency**: callsites remains at version 3.1.0 even if other packages require a newer version
- ⚠️ **Security**: No automatic updates for callsites (low risk as it's a simple package)
- ⚠️ **Technical debt**: Temporary solution that needs to be reviewed

### Risks

- **Future compatibility**: Other packages might require `callsites@4.x+`
- **Maintenance**: Need to monitor cucumber-tsflow updates

### Required Monitoring

- Periodically check if cucumber-tsflow has fixed the issue
- Monitor new versions of cucumber-tsflow
- Remove the resolution as soon as a compatible version is available

## References

- [GitHub callsites issue: Breaking change to ES modules](https://github.com/sindresorhus/callsites/releases/tag/v4.0.0)
- [Bun resolutions documentation](https://bun.sh/docs/install/workspaces#overriding-dependencies)
- [Cucumber configuration documentation](https://github.com/cucumber/cucumber-js/blob/main/docs/configuration.md#finding-your-code)

## Date

2025-10-07

## Authors

- Claude (GitHub Copilot Assistant)
- Technical support for ES modules incompatibility resolution